# 기능 요청: 관리자 패널 - 사용자 일괄 추가 기능

## 📋 요구사항 개요

회원 가입 요청을 하려면 먼저 시트에 **학번/교번(`no_member`)**과 **이름(`name_member`)**이 저장되어 있어야 합니다. 관리자가 관리자 패널에서 여러 사용자를 한번에 추가할 수 있는 기능이 필요합니다.

## 🎯 목적

- 회원 가입 전에 기본 정보(학번/교번, 이름)를 시트에 미리 등록
- 관리자가 여러 사용자를 한번에 추가할 수 있도록 지원
- 효율적인 사용자 관리

## 📊 시트 구조

**시트명**: `user` (hp_member 스프레드시트)

| 컬럼 | 필드명 | 설명 | 필수 여부 |
|------|--------|------|----------|
| A | `no_member` | 학번/교번 | ✅ 필수 |
| B | `user_type` | 사용자 유형 | ❌ (나중에 채움) |
| C | `name_member` | 이름 | ✅ 필수 |
| D | `google_member` | Google 계정 (암호화) | ❌ (나중에 채움) |
| E | `Approval` | 승인 상태 | ❌ (나중에 채움) |
| F | `is_admin` | 관리자 여부 | ❌ (나중에 채움) |
| G | `approval_date` | 승인 날짜 | ❌ (나중에 채움) |

**추가할 필드**: `no_member`, `name_member`만 채우면 됩니다.

## 🛠️ 구현 계획

### 1. 프론트엔드 (React)

#### 1.1 관리자 패널에 버튼 추가
- **위치**: `src/components/features/admin/AdminPanel.tsx`
- **버튼 위치**: UserList 섹션 상단 또는 헤더 영역
- **버튼 텍스트**: "사용자 일괄 추가" 또는 "사용자 추가"

#### 1.2 모달 컴포넌트 생성
- **파일명**: `src/components/features/admin/AddUsersModal.tsx`
- **스타일**: `CreateLedgerModal.tsx` 스타일 재사용 (`accounting.css` 또는 유사한 스타일)
- **기능**:
  - 여러 사용자를 한번에 입력할 수 있는 테이블 형태
  - 각 행에 `no_member`(학번/교번), `name_member`(이름) 입력 필드
  - 행 추가/삭제 기능
  - **엑셀 양식 다운로드 기능** (템플릿 파일 제공)
  - **엑셀 파일 업로드 기능** (양식에 입력한 엑셀 파일 업로드)
  - 유효성 검사 (학번 형식, 이름 필수 등)

#### 1.3 모달 UI 구조
```
┌─────────────────────────────────────┐
│ 사용자 일괄 추가              [×]   │
├─────────────────────────────────────┤
│                                     │
│ [방법 1: 직접 입력]                 │
│ [행 추가] 버튼                      │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 학번/교번  │  이름    │ [삭제] │ │
│ ├─────────────────────────────────┤ │
│ │ [입력]     │ [입력]   │ [×]    │ │
│ │ [입력]     │ [입력]   │ [×]    │ │
│ │ [입력]     │ [입력]   │ [×]    │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ─────────────────────────────────── │
│                                     │
│ [방법 2: 엑셀 파일 업로드]          │
│ [엑셀 양식 다운로드] 버튼           │
│ [엑셀 파일 선택] 버튼               │
│                                     │
│ [취소]  [추가]                      │
└─────────────────────────────────────┘
```

#### 1.4 엑셀 파일 처리
- **라이브러리**: `xlsx` (이미 프로젝트에 포함됨)
- **엑셀 양식 구조**:
  - 첫 번째 행: 헤더 (`학번/교번`, `이름`)
  - 두 번째 행부터: 데이터 행
- **엑셀 양식 다운로드**:
  - 버튼 클릭 시 템플릿 엑셀 파일 생성 및 다운로드
  - 샘플 데이터 1-2개 포함 (예시용)
- **엑셀 파일 업로드**:
  - 파일 선택 → 파싱 → 유효성 검사 → 테이블에 표시
  - 업로드 전 미리보기 제공

#### 1.5 API 호출
- **파일**: `src/utils/api/apiClient.ts`
- **메서드**: `addUsersToSpreadsheet(users: Array<{no_member: string, name_member: string}>)`
- **Apps Script 액션**: `addUsersToSpreadsheet`

### 2. 백엔드 (Google Apps Script)

#### 2.1 새 함수 추가
- **파일**: `appScript/UserManagement.gs` (새 파일) 또는 기존 파일에 추가
- **함수명**: `addUsersToSpreadsheet`
- **기능**:
  - 여러 사용자 정보를 받아서 시트에 추가
  - 중복 체크 (학번 기준)
  - 유효성 검사
  - 성공/실패 응답 반환

#### 2.2 함수 시그니처
```javascript
/**
 * 사용자 일괄 추가
 * @param {Object} req - 요청 데이터
 * @param {Array} req.users - 사용자 배열 [{no_member: string, name_member: string}, ...]
 * @returns {Object} 추가 결과
 */
function addUsersToSpreadsheet(req) {
  // 1. 스프레드시트 연결
  // 2. 중복 체크 (no_member 기준)
  // 3. 유효성 검사
  // 4. 시트에 추가 (no_member, name_member만)
  // 5. 결과 반환
}
```

#### 2.3 처리 로직
1. `hp_member` 스프레드시트의 `user` 시트 접근
2. 각 사용자에 대해:
   - `no_member` 중복 체크
   - 필수 필드 검증
   - 새 행 추가 (A열: `no_member`, C열: `name_member`)
3. 성공/실패 결과 반환

## 📝 상세 구현 사항

### 프론트엔드 컴포넌트 구조

```typescript
// AddUsersModal.tsx
interface UserInput {
  no_member: string;
  name_member: string;
}

interface AddUsersModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
}

// 상태 관리
const [users, setUsers] = useState<UserInput[]>([
  { no_member: '', name_member: '' }
]);
const [isLoading, setIsLoading] = useState(false);
const [error, setError] = useState<string | null>(null);
const [uploadMode, setUploadMode] = useState<'manual' | 'excel'>('manual');

// 엑셀 파일 처리 함수
const handleDownloadTemplate = () => {
  // xlsx 라이브러리를 사용하여 템플릿 엑셀 파일 생성
  // 헤더: ['학번/교번', '이름']
  // 샘플 데이터 1-2개 포함
};

const handleExcelUpload = (file: File) => {
  // xlsx 라이브러리를 사용하여 엑셀 파일 파싱
  // 유효성 검사 후 users 상태에 추가
};
```

### 유효성 검사 규칙

1. **학번/교번 (`no_member`)**:
   - 필수 입력
   - 숫자 8-15자리 형식 (기존 `isValidStudentId` 함수 재사용 가능)
   - 중복 불가

2. **이름 (`name_member`)**:
   - 필수 입력
   - 공백만으로 구성 불가

### Apps Script 응답 형식

```javascript
{
  success: true,
  message: '3명의 사용자가 추가되었습니다.',
  data: {
    added: 3,
    skipped: 1,  // 중복으로 인해 건너뛴 수
    errors: []  // 에러 발생한 항목들
  }
}
```

## 🔄 작업 흐름

### 방법 1: 직접 입력
1. 관리자가 관리자 패널 접속
2. "사용자 일괄 추가" 버튼 클릭
3. 모달 열림 → "직접 입력" 탭 선택
4. 사용자 정보 입력 (여러 명)
5. "추가" 버튼 클릭
6. API 호출 → Apps Script 함수 실행
7. 시트에 사용자 정보 추가
8. 성공 메시지 표시 및 사용자 목록 새로고침

### 방법 2: 엑셀 파일 업로드
1. 관리자가 관리자 패널 접속
2. "사용자 일괄 추가" 버튼 클릭
3. 모달 열림 → "엑셀 파일 업로드" 탭 선택
4. "엑셀 양식 다운로드" 버튼 클릭 → 템플릿 파일 다운로드
5. 다운로드한 엑셀 파일에 사용자 정보 입력
6. "엑셀 파일 선택" 버튼 클릭 → 파일 업로드
7. 엑셀 파일 파싱 및 미리보기 표시
8. "추가" 버튼 클릭
9. API 호출 → Apps Script 함수 실행
10. 시트에 사용자 정보 추가
11. 성공 메시지 표시 및 사용자 목록 새로고침

## ✅ 체크리스트

### 프론트엔드
- [ ] `AdminPanel.tsx`에 버튼 추가
- [ ] `AddUsersModal.tsx` 컴포넌트 생성
- [ ] 모달 스타일링 (기존 모달 스타일 재사용)
- [ ] 탭 기능 (직접 입력 / 엑셀 파일 업로드)
- [ ] 행 추가/삭제 기능
- [ ] **엑셀 양식 다운로드 기능** (xlsx 라이브러리 사용)
- [ ] **엑셀 파일 업로드 및 파싱 기능** (xlsx 라이브러리 사용)
- [ ] 엑셀 데이터 미리보기 기능
- [ ] 유효성 검사 로직
- [ ] `apiClient.ts`에 API 메서드 추가
- [ ] 에러 처리 및 로딩 상태 관리
- [ ] 성공 후 사용자 목록 새로고침

### 백엔드 (Apps Script)
- [ ] `addUsersToSpreadsheet` 함수 작성
- [ ] 중복 체크 로직
- [ ] 유효성 검사 로직
- [ ] 시트에 데이터 추가 로직
- [ ] 에러 처리 및 응답 형식

### 테스트
- [ ] 단일 사용자 추가 테스트
- [ ] 여러 사용자 일괄 추가 테스트
- [ ] 중복 학번 처리 테스트
- [ ] 유효하지 않은 데이터 처리 테스트
- [ ] 빈 값 처리 테스트
- [ ] **엑셀 양식 다운로드 테스트**
- [ ] **엑셀 파일 업로드 및 파싱 테스트**
- [ ] **엑셀 파일 형식 오류 처리 테스트**
- [ ] **엑셀 파일 빈 행 처리 테스트**

## 🎨 UI/UX 고려사항

1. **입력 편의성**:
   - Tab 키로 다음 필드 이동
   - Enter 키로 다음 행 추가
   - 엑셀 파일 업로드 지원

2. **엑셀 파일 처리**:
   - 엑셀 양식 다운로드 시 샘플 데이터 포함
   - 업로드 전 미리보기 제공
   - 파싱 오류 시 명확한 에러 메시지 표시
   - 지원 파일 형식: `.xlsx`, `.xls`

3. **피드백**:
   - 실시간 유효성 검사 표시
   - 추가 중 로딩 표시
   - 성공/실패 메시지 표시
   - 엑셀 파일 업로드 진행률 표시

4. **에러 처리**:
   - 각 행별 에러 표시
   - 전체 에러 요약 표시
   - 엑셀 파일 형식 오류 시 안내 메시지

## 📌 참고 파일

- 모달 스타일 참고: `src/components/features/accounting/CreateLedgerModal.tsx`
- 모달 CSS: `src/components/features/accounting/accounting.css`
- API 클라이언트: `src/utils/api/apiClient.ts`
- Apps Script 유저 관리: `appScript/UserRegistration.gs`
- Apps Script 스프레드시트 유틸: `appScript/SpreadsheetUtils.gs`
- 엑셀 라이브러리: `xlsx` (package.json에 이미 포함됨)

## 📦 엑셀 파일 처리 상세

### 엑셀 양식 구조
```
| 학번/교번 | 이름     |
|-----------|----------|
| 20230701  | 홍길동   |
| 20230702  | 김철수   |
```

### 엑셀 파일 파싱 로직
1. 파일 선택 → FileReader로 읽기
2. xlsx 라이브러리로 파싱
3. 첫 번째 행을 헤더로 인식
4. 두 번째 행부터 데이터로 처리
5. 빈 행은 무시
6. 유효성 검사 수행
7. 검증 통과한 데이터를 테이블에 표시

### 엑셀 파일 다운로드 로직
1. xlsx 라이브러리로 워크북 생성
2. 헤더 행 추가: `['학번/교번', '이름']`
3. 샘플 데이터 1-2개 추가
4. 파일 다운로드 (파일명: `사용자_일괄_추가_양식.xlsx`)

## ❓ 검토 사항

1. ✅ **엑셀 파일 업로드 기능** 포함 (확정)
2. **사용자 유형(`user_type`)**도 함께 입력받을까요? (현재는 나중에 채우는 것으로 가정)
3. **에러 발생 시 부분 성공 처리**: 일부는 성공하고 일부는 실패한 경우 어떻게 처리할까요?
4. **추가 후 즉시 승인**: 추가한 사용자를 바로 승인 상태로 만들까요? (현재는 승인 전 상태로 유지)
5. **엑셀 파일 최대 행 수 제한**: 한 번에 몇 명까지 추가 가능하게 할까요? (예: 100명)

---

**작성일**: 2024-12-19  
**작성자**: AI Assistant  
**상태**: 검토 대기 중

